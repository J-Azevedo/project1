/* Includes ------------------------------------------------------------------*/
#include "gyroscopeDriver.h"
#include "gyroProcessingTask.h"
#include <FreeRTOS.h>
#include <task.h>
#include <queue.h>
#include <semphr.h>
#include <stdlib.h>
#include "main.h"
#include <math.h> 
 #define INVALID_DATA -1
 //data used to train the algorithm, it is used in the comparison of the values
float trainedData[11][99] = 
{
{ 0.761250,0.901250,3.307500,6.938750,10.648750,14.227500,20.728750,22.452499,25.646250,21.428751,21.280001,18.996250,14.673750,12.390000,16.388750,19.643749,21.385000,27.483749,24.237499,16.467501,12.941250,13.772500,11.663750,16.476250,21.139999,23.467501,20.641251,19.057501,15.085000,14.148750,15.916250,17.097500,14.708750,10.193750,11.480000,15.093750,15.636250,9.301250,10.500000,11.891250,10.517500,10.316250,6.868750,0.463750,0.726250,-1.102500,-0.131250,-0.262500,1.863750,-0.892500,-0.315000,-0.822500,-1.067500,-3.482500,-2.493750,-6.833750,-9.030000,-10.797500,-16.931250,-17.587500,-13.492500,-21.840000,-25.541250,-23.887501,-23.616251,-26.827499,-23.843750,-23.178751,-26.066250,-26.844999,-39.235001,-47.888752,-27.107500,-21.603750,-14.148750,-13.632500,-10.867500,-13.256250,-12.670000,-14.761250,-20.440001,-20.378750,-20.186251,-20.807501,-19.792500,-17.508751,-16.266251,-15.627501,-12.845000,-12.547500,-9.966250,-12.582500,-15.531250,-18.348749,-14.770000,-6.098750,6.116250,7.647500,4.270000 }
, { 10.421250,0.437500,-0.525000,-0.577500,3.937500,4.655000,7.866250,9.021250,6.273750,4.471250,3.596250,11.243750,10.395000,20.186251,23.073750,16.275000,12.530000,9.616250,9.345000,11.698750,15.172500,18.777500,18.322500,18.191250,18.514999,20.606251,17.587500,12.661250,10.806250,11.865000,14.183750,12.967500,13.072500,12.451250,14.367500,16.021250,14.875000,16.747499,13.063750,12.022500,12.372500,9.616250,6.816250,3.692500,1.260000,2.336250,2.607500,1.636250,1.417500,2.310000,2.756250,1.837500,-1.181250,-1.653750,-2.406250,-3.543750,-2.703750,-8.190000,-8.846250,-8.636250,-14.350000,-12.267500,-21.210001,-19.879999,-28.280001,-24.377501,-21.315001,-26.162500,-23.205000,-19.206249,-15.373750,-18.471251,-15.295000,-17.543751,-22.610001,-19.661249,-16.126249,-16.590000,-14.708750,-13.448750,-20.886250,-16.808750,-14.052500,-13.580000,-13.300000,-14.411250,-19.556250,-21.402500,-19.582500,-21.647501,-18.226250,-16.170000,-13.868750,-10.552500,-2.476250,-3.456250,1.968750,2.152500,6.317500 }
, { 3.605000,4.856250,10.447500,18.908751,20.623751,12.346250,13.772500,9.642500,14.000000,14.420000,18.733749,18.856251,18.488750,16.835001,18.348749,19.250000,20.711250,23.161249,15.435000,13.037500,15.566250,15.470000,15.636250,17.062500,15.872500,12.538750,9.476250,4.200000,4.838750,4.453750,9.380000,12.661250,11.996250,17.823750,16.143749,13.728750,12.880000,12.188750,8.741250,9.266250,7.778750,3.946250,4.383750,5.897500,7.192500,8.277500,8.601250,7.796250,6.413750,9.310000,5.302500,2.940000,-0.770000,-3.666250,-6.300000,-4.891250,-5.145000,-1.137500,-1.470000,-4.611250,-1.330000,-8.120000,-12.136250,-13.921250,-20.825001,-15.233750,-20.754999,-23.852501,-16.021250,-19.223749,-17.018749,-17.535000,-17.850000,-22.321251,-24.307501,-21.997499,-25.751249,-22.120001,-22.408751,-20.886250,-24.517500,-22.977501,-22.049999,-16.520000,-14.761250,-8.785000,-10.403750,-10.622500,-15.260000,-18.278749,-18.917500,-16.520000,-10.850000,-6.457500,-4.576250,-3.710000,-1.102500,-3.325000,-4.628750 }
, { 21.743750,33.634998,35.743752,34.168751,28.393749,17.946251,13.860000,11.173750,10.325000,11.252500,12.337500,10.867500,10.473750,9.546250,8.811250,13.308750,9.388750,12.136250,9.773750,10.185000,9.476250,12.398750,11.488750,16.117500,16.275000,9.415000,8.233750,6.501250,11.331250,11.287500,10.640000,10.517500,8.295000,4.410000,6.448750,7.901250,7.411250,7.787500,4.173750,5.302500,0.630000,-3.281250,-3.045000,-7.297500,-7.078750,-10.027500,-8.015000,-14.201250,-16.152500,-21.428751,-22.102501,-19.101250,-14.551250,-12.705000,-16.966249,-18.803751,-25.147501,-30.870001,-29.268749,-30.309999,-30.415001,-27.580000,-24.639999,-23.240000,-21.148750,-19.670000,-18.235001,-14.525000,-12.993750,-11.068750,-11.952500,-14.595000,-15.881250,-16.546249,-18.690001,-15.076250,-10.053750,-6.273750,-10.071250,-9.047500,-13.308750,-18.655001,-14.052500,-5.582500,3.220000,2.388750,5.967500,4.786250,4.217500,6.895000,3.762500,-1.872500,-0.131250,-2.021250,0.131250,0.481250,0.017500,0.997500,0.428750 }
,{ 13.160000,16.379999,20.877501,14.297500,14.017500,13.912500,19.591249,23.240000,24.666250,28.166250,26.118750,20.833750,17.263750,14.323750,17.412500,22.557501,23.782499,19.538750,17.753750,10.701250,7.936250,7.673750,12.407500,12.521250,11.480000,8.435000,8.408750,10.745000,14.280000,19.696251,18.042500,17.832500,7.945000,9.870000,12.705000,16.257500,18.252501,13.965000,11.576250,1.837500,1.050000,-0.192500,0.805000,1.863750,0.936250,1.233750,1.408750,-1.636250,-2.213750,-4.567500,-5.521250,-6.816250,-12.092500,-21.691250,-20.247499,-24.631250,-17.342501,-17.832500,-16.835001,-27.203751,-39.191250,-41.046249,-38.228748,-25.506250,-16.493750,-12.678750,-12.643750,-15.610000,-22.715000,-30.082500,-26.180000,-22.592501,-18.812500,-16.966249,-19.013750,-20.247499,-22.216249,-18.418751,-17.036249,-12.687500,-9.318750,-9.187500,-12.250000,-10.141250,-7.315000,-6.921250,-3.115000,7.070000,9.660000,4.191250,4.147500,6.676250,-1.601250,0.323750,-1.155000,-0.131250,-0.866250,2.380000,0.315000 }
,{ 4.480000,4.550000,7.612500,13.685000,20.098749,23.598749,29.785000,39.051250,37.406250,44.598751,31.902500,29.295000,22.155001,18.112499,14.271250,12.836250,13.798750,17.885000,17.806250,18.252501,15.680000,12.827500,12.250000,15.715000,18.112499,14.288750,16.143749,13.413750,7.420000,7.262500,11.602500,13.483750,3.211250,1.916250,5.162500,1.968750,-0.726250,-1.662500,-1.076250,-2.021250,-2.660000,-6.413750,-4.173750,-13.475000,-17.176250,-29.434999,-36.846249,-42.096249,-37.528751,-30.590000,-26.486250,-26.530001,-24.097500,-22.732500,-28.183750,-25.427500,-27.588751,-24.718750,-18.821251,-16.379999,-20.973749,-21.787500,-26.635000,-29.697500,-27.965000,-21.612499,-12.381250,-9.012500,-10.290000,-12.713750,-17.141251,-10.605000,-2.817500,12.075000,15.680000,10.963750,3.753750,-1.067500,4.445000,3.911250,2.187500,3.832500,3.552500,2.170000,2.266250,0.350000,0.437500,0.787500,-0.148750,0.953750,0.665000,0.026250,0.647500,-0.437500,-0.376250,-0.113750,-0.227500,0.857500,-0.026250 }
, { 2.730000,7.087500,4.243750,6.265000,16.441250,15.610000,20.440001,28.131250,25.611250,25.287500,24.307501,26.101250,24.508751,25.121250,26.748751,20.545000,19.871250,14.481250,11.112500,13.020000,18.296249,18.252501,19.512501,17.027500,13.545000,13.790000,15.758750,15.636250,18.462500,16.178751,11.926250,11.445000,5.923750,1.960000,0.542500,-0.603750,-2.703750,0.910000,-4.690000,-8.260000,-10.587500,-10.613750,-8.933750,-11.795000,-2.458750,-6.553750,-9.371250,-15.793750,-16.301250,-20.606251,-23.677500,-28.236250,-23.563749,-18.392500,-16.695000,-17.482500,-13.842500,-17.508751,-27.002501,-26.976250,-24.535000,-27.291250,-28.577499,-23.712500,-24.150000,-21.315001,-16.738750,-17.622499,-18.663750,-20.606251,-20.921249,-21.603750,-18.943750,-16.161249,-14.752501,-13.982500,-11.970000,-8.671250,-7.175000,-0.796250,4.637500,5.311250,5.355000,10.158750,0.770000,-0.551250,-2.231250,-4.252500,-1.741250,-4.453750,-3.080000,-5.416250,-3.368750,-1.863750,-0.883750,-0.393750,1.015000,1.505000,1.207500 }
,{ 14.271250,16.231251,15.155000,12.293750,14.778750,13.790000,12.005000,9.791250,9.388750,13.142500,22.198750,29.452499,32.165001,28.183750,17.500000,14.927500,15.540000,19.626249,20.396250,17.333750,16.782499,14.875000,5.031250,9.353750,12.757500,0.980000,8.645000,7.358750,4.593750,9.178750,1.435000,4.760000,1.566250,5.355000,2.450000,4.567500,5.057500,1.820000,1.391250,3.062500,-1.540000,-0.638750,-1.583750,-3.132500,-0.595000,-4.156250,-7.901250,-6.413750,-9.126250,-11.418750,-18.602501,-7.822500,-26.311251,-22.443750,-31.902500,-37.563751,-40.118752,-28.953751,-21.315001,-23.730000,-26.355000,-27.125000,-31.946251,-33.451252,-28.647501,-24.290001,-23.686251,-23.975000,-19.241251,-20.851250,-23.747499,-23.747499,-22.400000,-23.502501,-21.061251,-20.264999,-15.995000,-13.553750,-11.882500,-1.986250,1.846250,1.697500,3.972500,5.748750,6.002500,2.835000,0.210000,-2.266250,-0.078750,4.532500,-0.017500,-0.210000,1.102500,3.780000,1.443750,4.016250,1.443750,4.978750,1.986250 }
,{ 1.400000,1.732500,-1.146250,0.271250,3.045000,4.952500,11.086250,20.160000,22.478750,24.552500,28.787500,28.315001,24.482500,21.612499,15.155000,9.870000,9.598750,9.056250,9.660000,12.862500,10.517500,12.363750,9.528750,3.946250,7.787500,11.112500,12.398750,11.068750,10.867500,6.396250,6.177500,7.350000,7.498750,6.553750,8.540000,14.087500,16.738750,14.201250,11.392500,6.755000,4.523750,4.173750,5.092500,11.348750,13.020000,11.427500,8.312500,5.836250,3.281250,2.485000,1.960000,2.371250,1.347500,2.362500,0.306250,2.808750,2.353750,2.161250,0.332500,2.502500,2.143750,2.432500,1.828750,2.327500,1.400000,1.408750,1.102500,0.726250,-0.437500,-1.268750,-4.865000,-10.062500,-19.031250,-26.573750,-37.476250,-34.352501,-36.994999,-30.266251,-23.607500,-19.451250,-19.818750,-27.553751,-30.546249,-25.943750,-19.048750,-16.476250,-15.111250,-15.907500,-19.512501,-20.238750,-20.282499,-18.340000,-15.916250,-19.600000,-15.050000,-19.451250,-20.081249,-22.102501,-28.323750 }
,{ 17.806250,23.073750,23.065001,19.512501,18.786249,23.432501,16.887501,10.622500,8.583750,3.255000,4.716250,8.443750,12.110000,13.431250,11.418750,15.601250,11.156250,8.303750,6.816250,5.390000,2.397500,8.015000,10.946250,13.247500,9.266250,8.872500,8.767500,4.760000,7.017500,10.990000,15.925000,13.090000,10.132500,13.606250,12.993750,8.540000,5.740000,8.286250,5.678750,5.433750,7.166250,6.737500,4.725000,5.468750,2.458750,4.130000,1.190000,0.385000,-2.222500,-1.960000,-1.680000,-2.467500,-1.680000,-3.806250,-5.005000,-7.472500,-7.787500,-18.287500,-10.762500,-21.656250,-16.126249,-14.175000,-10.080000,-7.927500,-12.180000,-15.951250,-19.530001,-17.605000,-23.275000,-17.307501,-19.547501,-17.990000,-15.242500,-16.362499,-19.013750,-21.708750,-21.087500,-17.211250,-16.187500,-12.783750,-15.872500,-13.842500,-15.461250,-14.857500,-12.617500,-12.661250,-13.807500,-11.488750,-8.995000,-12.118750,-15.338750,-11.095000,-6.615000,-2.642500,-1.408750,-0.498750,-0.665000,-2.590000,-0.087500 }
,{ 11.200000,11.427500,19.075001,22.277500,17.237499,15.286250,12.433750,11.200000,9.266250,11.506250,7.376250,2.861250,5.985000,4.471250,6.868750,9.476250,11.480000,9.012500,5.818750,8.505000,11.471250,13.273750,12.005000,7.411250,10.097500,10.500000,9.808750,10.990000,10.535000,9.380000,10.508750,8.225000,11.751250,9.493750,8.085000,9.222500,7.778750,5.521250,7.761250,7.612500,5.748750,6.545000,10.263750,9.983750,7.673750,7.122500,7.603750,2.922500,2.668750,1.015000,0.577500,2.161250,2.056250,3.430000,4.095000,8.067500,8.925000,7.393750,6.168750,2.091250,0.008750,-0.892500,-1.435000,-4.873750,-12.355000,-21.743750,-31.666250,-30.380001,-25.427500,-21.078751,-19.232500,-17.430000,-19.075001,-24.745001,-26.538750,-25.663750,-23.660000,-24.456249,-27.833750,-22.653749,-21.770000,-17.885000,-14.971251,-15.811250,-13.798750,-21.350000,-19.503750,-16.738750,-15.487500,-10.727500,-8.881250,-8.461250,-8.452500,-12.110000,-14.323750,-10.675000,-9.240000,-4.462500,-5.818750 }
};

//kernel distance (with k=3) of every nearest neighbour, nearest neighbour
float nearestNeighbour2[99][11] =//k=3
{
	{ 1.817083,2.455833,1.318333,6.664583,1.936666,1.901667,1.318333,2.572500,1.391250,4.039583,1.936666 },
	{ 1.647917,1.957083,1.887083,15.073331,3.931666,1.887083,3.036250,3.931666,1.647917,8.032499,4.698750 },
	{ 3.024584,3.074167,4.582083,14.737918,3.237500,3.502917,3.024584,4.783334,3.488333,4.695834,3.237500 },
	{ 4.232083,5.069167,2.861250,13.935834,2.409167,2.409167,4.232083,2.916667,4.503333,2.861250,4.704583 },
	{ 4.430417,5.894583,1.916252,8.557500,2.135000,1.566250,1.601249,1.627500,6.489583,1.566250,1.601249 },
	{ 0.603750,5.707916,1.630417,2.905001,0.603750,4.602499,1.134583,0.667917,5.509583,4.491666,0.918750 },
	{ 1.755833,3.975417,1.064583,1.122916,1.563334,9.531667,1.563334,1.038333,1.650833,2.948750,1.038333 },
	{ 2.919584,0.997500,0.583334,0.653333,2.919584,14.443334,6.180418,0.583334,4.447917,0.653333,0.670833 },
	{ 1.394166,2.805833,4.340000,1.245417,1.370833,12.098332,1.370833,0.621250,2.829166,1.076250,0.621250 },
	{ 4.573332,5.010833,2.452917,1.770417,4.410000,18.596666,2.490833,1.601250,2.490833,5.821667,1.601250 },
	{ 2.164167,4.547083,3.861668,6.326250,2.800000,5.497917,2.315833,2.164167,3.421250,3.800416,3.800416 },
	{ 3.027499,3.596250,3.120832,3.596250,3.027499,1.443750,2.919584,1.548749,1.443750,3.602083,7.323750 },
	{ 2.989584,2.024166,2.902084,1.971666,2.902084,2.782500,2.800000,8.449584,2.782500,1.971666,5.007917 },
	{ 1.939583,2.283750,2.380000,3.835416,1.779167,2.283750,3.835417,5.877083,2.811666,1.779167,7.317917 },
	{ 1.122917,4.657917,1.248332,3.336667,0.682500,1.951250,7.107918,0.682500,1.458334,3.065417,4.631666 },
	{ 1.402917,1.662500,1.554583,1.461250,2.744584,1.776250,1.402917,1.213333,2.266250,1.213333,2.528750 },
	{ 1.528333,1.230833,1.528333,1.356250,3.126666,1.776250,2.088333,2.937083,1.216250,1.085000,1.085000 },
	{ 6.708333,0.825417,3.826667,2.648333,1.787916,2.266250,3.537917,1.787916,0.452083,0.924583,0.452083 },
	{ 5.585416,0.837083,3.004166,0.627083,1.671250,1.671250,1.519583,3.024583,0.627083,2.123333,2.788333 },
	{ 2.027083,1.160834,0.510417,1.236666,1.225000,2.639584,0.498750,2.027083,0.498750,4.407084,2.330417 },
	{ 2.041667,0.837084,0.574583,1.525416,2.552083,0.574583,2.286666,1.277500,1.472917,6.912500,1.472917 },
	{ 0.848750,2.578333,1.496250,0.446250,3.252084,0.446250,2.228333,1.099583,0.469583,3.024584,0.606667 },
	{ 0.367500,3.263750,3.100416,0.411250,0.434584,0.329583,4.057084,5.623333,1.837500,0.772917,0.329583 },
	{ 0.498750,1.335833,0.522083,0.557083,2.362500,0.825417,0.498750,3.001250,5.815834,2.021250,3.505833 },
	{ 3.505833,1.755833,1.656666,1.493333,1.575000,1.493333,1.726667,1.575000,2.493750,1.507917,1.507917 },
	{ 7.239168,5.331667,1.475833,0.869166,1.160833,1.808333,1.475833,7.927500,1.245417,0.869166,1.108333 },
	{ 4.144584,2.108750,0.624166,0.373333,0.256667,1.857916,1.857916,0.256667,2.957500,0.338333,0.845833 },
	{ 5.153751,1.338750,2.006667,1.633333,0.828334,1.773333,2.872917,2.205000,0.665000,1.633333,0.665000 },
	{ 2.645416,0.285834,1.668333,0.595000,2.388750,1.936667,4.897083,1.831667,0.285834,1.668333,0.466667 },
	{ 2.391667,1.245417,3.158750,0.927500,5.632084,1.633334,3.287084,1.309583,1.863750,0.927500,1.239583 },
	{ 1.289166,1.910417,1.537083,0.784583,2.700833,0.793333,1.009167,7.253750,3.998750,1.289166,0.784583 },
	{ 2.785417,0.315000,0.519167,1.787917,3.275417,0.577500,1.222083,3.937500,2.210833,0.315000,2.129166 },
	{ 2.435416,1.344583,1.061667,0.994583,0.939167,2.881667,1.989167,3.978333,0.939167,1.773334,1.061667 },
	{ 1.093750,1.997917,5.739999,1.846250,1.093750,1.992083,1.962917,1.846250,2.094167,2.767916,1.338750 },
	{ 1.875417,1.604167,2.788333,1.671250,1.058750,2.307083,4.144583,2.872916,1.828750,1.058750,1.671250 },
	{ 1.032500,1.032500,1.338750,1.764583,1.190000,3.701250,5.416250,3.301666,1.099583,1.764583,2.170000 },
	{ 1.493334,1.540000,2.870000,1.464167,2.502501,4.742500,6.060833,1.919167,1.493334,1.464167,1.709167 },
	{ 1.805417,3.295833,2.225416,1.426250,1.598333,4.412917,2.697917,2.697917,1.598333,1.426250,2.910833 },
	{ 1.242500,1.907500,1.796667,2.625000,0.915833,3.777083,6.186250,3.179167,0.915833,2.216667,1.933750 },
	{ 2.345000,2.432500,2.263333,1.274583,2.762083,5.060417,9.219584,1.945417,1.210417,1.210417,1.563333 },
	{ 2.648333,3.885000,1.793750,1.960000,2.161250,2.706667,9.397500,1.960000,2.374167,1.557500,1.557500 },
	{ 2.683333,2.216666,1.872500,2.954583,2.557917,4.369167,7.169167,2.557917,1.720833,1.849167,1.720833 },
	{ 1.324167,1.289167,1.160833,2.146667,3.272500,2.826250,5.999584,2.146667,0.933333,0.933333,4.004583 },
	{ 2.741667,1.936667,2.222500,4.946667,2.277917,6.066667,4.946667,4.252500,4.232083,1.936667,3.322083 },
	{ 0.688333,0.685417,3.680834,6.302917,0.685417,13.798751,2.814584,1.569167,7.245000,1.484583,3.680834 },
	{ 2.942917,2.111667,2.817500,6.090000,2.111667,22.522499,3.774167,3.613750,4.917500,2.560833,2.817500 },
	{ 1.866667,1.785000,2.426666,3.117917,0.985833,28.417084,4.022083,3.117917,2.234166,0.985833,2.234166 },
	{ 1.306667,1.478750,4.331250,7.315000,2.222500,29.959999,8.376666,5.909167,3.024583,1.306667,2.245833 },
	{ 0.889583,1.187083,3.809167,7.035000,2.572500,23.668753,7.134167,6.947500,1.297917,2.578334,0.889583 },
	{ 2.059167,1.557500,7.373333,6.664584,3.955000,12.772082,6.664584,8.499167,1.674167,2.216667,1.557500 },
	{ 1.510833,1.840417,3.537916,3.152916,5.048750,5.025416,3.152916,5.486249,1.484583,2.420833,1.484583 },
	{ 2.429583,0.653333,0.816667,9.280833,3.782917,9.280833,10.418333,4.453750,0.437500,3.432917,0.437500 },
	{ 0.341250,0.341250,0.539583,7.005833,7.927500,4.097917,4.097917,5.573751,1.747083,0.673750,2.219584 },
	{ 0.778750,1.997917,0.778750,7.857500,1.697500,1.890000,3.896667,1.697500,3.642917,0.872083,4.354583 },
	{ 1.799583,1.799583,2.998334,4.739583,4.923334,7.624167,4.739583,10.103333,3.100417,2.135000,5.626250 },
	{ 1.957083,2.855417,1.957083,4.590833,4.590833,5.121666,5.471667,14.609584,6.437083,2.382917,9.942916 },
	{ 3.313333,4.194167,2.989583,7.183750,6.539167,8.405833,4.789167,16.759169,6.375833,2.989583,10.756667 },
	{ 5.451251,6.326251,6.294167,6.883334,2.555000,5.605834,2.604584,5.605834,6.294167,2.555000,9.782500 },
	{ 2.123334,5.760417,5.605833,6.889165,2.187499,2.123334,5.378333,3.785833,5.605833,4.719167,9.496667 },
	{ 3.806250,6.906666,5.947083,4.340000,2.269167,4.611250,2.269167,2.931250,6.221250,3.806250,5.947083 },
	{ 3.657499,3.085833,5.658333,6.238750,12.089583,4.596667,3.753751,3.753751,7.081666,3.085833,5.658333 },
	{ 3.596250,5.191667,5.810000,2.161250,13.714166,3.631250,1.968750,1.968750,9.525833,5.191667,7.309166 },
	{ 1.677083,4.395416,7.277084,2.108750,9.175832,1.677083,2.782500,4.987500,9.712499,7.277084,7.536667 },
	{ 0.813751,3.733334,7.000000,1.128750,1.892917,4.585001,0.813751,7.087502,11.235001,6.434167,6.434166 },
	{ 1.930833,1.604167,2.146666,1.930833,4.261250,1.604167,2.286666,1.849167,15.076249,4.377916,4.261250 },
	{ 3.357082,1.723750,2.569583,1.887083,4.272917,0.790416,0.790416,1.723750,16.030001,2.569583,0.877916 },
	{ 1.925000,1.572084,1.434999,1.770416,3.316250,3.491250,2.767916,1.820000,15.023750,1.434999,8.717916 },
	{ 1.484583,2.493750,1.035416,2.420833,1.697500,6.900833,1.709167,1.035416,13.775416,1.697500,5.716667 },
	{ 2.097083,0.927500,2.963334,3.800417,1.254166,5.602917,2.423751,2.423751,12.664166,0.927500,1.671250 },
	{ 4.999166,1.020834,1.009167,5.340416,7.157501,4.243750,0.700000,0.700000,12.427917,2.371249,0.851667 },
	{ 15.618752,2.277917,1.327084,4.558750,4.774584,1.327084,1.962916,3.152917,9.916667,1.365000,1.365000 },
	{ 25.240835,0.819584,0.498750,3.056666,2.088333,3.785834,2.088333,2.858332,4.147500,0.498750,0.568750 },
	{ 6.938750,1.064583,1.079166,1.064583,0.204167,12.655417,0.116667,3.383332,0.116667,1.099583,0.145834 },
	{ 1.919167,0.918751,1.440833,0.329583,0.533751,28.431665,0.463750,1.440833,3.050832,0.329583,1.831666 },
	{ 3.336667,2.280833,2.391666,1.006250,0.790417,31.543753,2.934167,1.881250,12.990832,0.790417,3.879166 },
	{ 2.607500,1.079167,1.257083,2.374166,0.688334,25.194168,2.374166,0.688334,11.229168,1.064583,4.340000 },
	{ 2.347917,3.082916,3.430000,2.890417,2.035833,14.717500,2.347917,3.082916,13.119166,2.788333,2.035833 },
	{ 2.528750,1.828750,3.648750,4.862083,2.245834,8.332917,3.955000,2.330417,8.601251,1.828750,4.727916 },
	{ 1.808333,1.948333,3.998750,2.435416,2.514166,14.154584,4.366250,1.808333,3.998750,1.948333,6.816250 },
	{ 1.787917,0.912916,3.109166,3.925833,0.977083,7.854584,4.716250,4.716250,3.109166,0.912916,4.287500 },
	{ 0.799166,0.799166,3.485416,4.354583,7.014584,4.765833,6.399167,4.765833,1.213333,3.692500,1.388334 },
	{ 2.272083,1.962917,3.832500,1.446667,6.991251,5.544584,6.530417,5.544584,6.883334,3.887917,1.446667 },
	{ 3.934583,0.775834,5.177082,0.775834,2.108750,6.008333,6.930000,6.008333,11.313748,1.102500,0.775834 },
	{ 4.806667,2.149584,1.770417,6.769583,4.237917,6.440000,9.380000,6.440000,8.230834,1.297917,1.297917 },
	{ 3.922916,0.880833,1.522499,2.062083,5.923750,2.062083,3.059583,3.917084,3.427083,1.335833,0.880833 },
	{ 2.657084,2.304167,3.788750,1.808333,4.657917,1.808333,2.409167,2.105833,2.304167,3.147083,5.217917 },
	{ 2.283750,2.595833,4.657917,6.495417,2.587083,2.149583,1.997917,1.997917,2.283750,2.388750,2.560833 },
	{ 1.843333,5.311250,3.718750,4.445000,5.967500,4.030834,4.465417,4.030833,1.843333,3.141250,2.202083 },
	{ 2.969167,2.829167,2.298333,4.701667,8.329999,2.009583,3.071250,2.009583,2.782500,5.535834,2.298333 },
	{ 2.660000,4.625834,3.686667,3.669167,2.094167,4.074584,6.448750,2.094167,3.686667,2.660000,3.161666 },
	{ 4.447917,1.878333,1.878333,2.420833,2.677500,2.420833,4.202917,2.508333,2.788333,3.803333,4.447917 },
	{ 3.004167,2.035833,2.035833,2.368333,7.361666,2.525833,3.931667,2.368333,3.249166,3.065417,3.266667 },
	{ 2.242917,2.242917,3.217083,1.160833,1.828750,1.160833,2.750417,1.464167,2.499583,3.106250,3.106250 },
	{ 5.095417,4.482916,4.115416,0.787500,1.764583,1.257083,0.787500,4.439167,5.929585,1.201667,4.482916 },
	{ 3.640000,1.327083,2.896250,0.936250,0.434583,0.597917,0.434583,1.820000,3.826667,0.603750,3.640000 },
	{ 3.202500,1.951250,1.951250,0.694167,0.215833,0.227500,0.215833,3.937500,12.623333,0.285833,6.253334 },
	{ 4.640417,1.143333,0.516250,0.603750,0.358750,0.440417,0.793333,0.793333,16.344999,0.358750,8.362083 },
	{ 4.477083,0.676667,2.018333,0.600833,0.828334,0.694167,0.600833,2.697917,18.643335,2.018333,2.776667 },
	{ 2.464583,3.829583,3.444583,0.361667,0.285833,0.285833,0.816667,1.335833,24.812082,0.326667,4.237916 }
};


extern xSemaphoreHandle xSemMicrophoneStart;
extern xQueueHandle xQGyroData;
//static l3gd20Data lastcaptures[20];
extern xTaskHandle xTskGyroAcquisition;


struct processementData
{

	float f;	
	struct processementData *nextValue;
		
};
//auxiliar data struct for making the processing task easier
struct auxiliarData
{
	float distance;
	int position;
};

struct processementData *firstValue=NULL;
struct processementData *lastValue=NULL;

/*
data processement function, that implements a one classe nearest neighbour classification algorithm, using a kernel distance
with k=3
*/
static int dataProcessement()
{
	
	int probability = 0;

	struct auxiliarData minimum;
	float aux;
	int i=0;
	//here we go through the linked list where the last 100 values of the gyro are stored
	for(struct processementData *tmp=firstValue ;tmp->nextValue!=NULL;tmp=tmp->nextValue)
	{
		minimum.distance = 100;
		for (int j = 0; j < 11; j++)
		{
			//we get the distance between the acquired data and the training data
			aux = fabsf(trainedData[j][i] - tmp->f);
			//and get the smallest distance between both, that should give us the nearest neighbour
			if (aux < minimum.distance)
			{
				
				minimum.distance = aux;
				minimum.position = j;
			}

		}
		/*
		if the distance between the acquired data and the nearest neighbour, is smaller than the
		distance between the nearest neigbour, and the nearest neigbour of the nearest neigbour
		the probability of the data to be part of our is increased	
		*/
		if (nearestNeighbour2[i][minimum.position] > minimum.distance)
			probability++;
			i++;

	}
//if the value probabilty is higher than 75 we acept the acquired data has part of the class, which means it positive input
	if (probability > 75)
		return 0;
	else
	{
		return INVALID_DATA;
	}
}
/*function to cleanup the list that stores the acquired data, that is called when the data matches our class*/
static void listCleanup(void)
{
	struct processementData *pointer=firstValue;
	struct processementData *tmp;
	while(pointer!=NULL)
	{
		tmp=pointer->nextValue;
		vPortFree(pointer);
		pointer=tmp;
	}
}

	//struct processementData values[100];
void gyroProcessingTask()
{
	static int i=0;
	int k=0;
	 
	struct processementData 	*newdata;
	struct processementData *auxiliarPointer;
	int heap= xPortGetFreeHeapSize() ;
	newdata = ( struct processementData *)pvPortMalloc(sizeof(struct processementData)); 
	 if (newdata== NULL)
	 {
			k++;
        return;
	 }
	 xQueueReceive(xQGyroData,&newdata->f,portMAX_DELAY);
	 
	 if(i>99)
	 {
			lastValue->nextValue=newdata;
			lastValue=newdata;
			
			auxiliarPointer=firstValue->nextValue;
			vPortFree(firstValue);
			firstValue=auxiliarPointer;

		 if(dataProcessement()!=INVALID_DATA)
		 {
			 //funtion called to clean the linked list
			 listCleanup();
			 	//semaphore to sinalize correct movement
			 //and to initialize the microphone recording
			 xSemaphoreTake(xSemMicrophoneStart,portMAX_DELAY);
			 /*
			 we now have to suspend the acquisition task it should remain suspend, until either the 
			if the call was sucssefuly resolved or if the voice input of the microphone isn't one of the key words 
			 we only suspend the acquisition task because the processing tasks will be automaticly suspended by the queue*/
			vTaskSuspend(xTskGyroAcquisition);	 

		 }
	 }
	else
	{
		 i++;
		if(firstValue==NULL)
		 {
			firstValue=newdata;
			lastValue=newdata;
		 }
		 else
		 {
			 lastValue->nextValue=newdata;
			 lastValue=newdata;
			 if(i==99)
			 {
					if(dataProcessement()!=INVALID_DATA)
					{
						//funtion called to clean the linked list
					 listCleanup();
						//semaphore to sinalize correct movement
					 //and to initialize the microphone recording
					 xSemaphoreTake(xSemMicrophoneStart,portMAX_DELAY);
					 /*
					 we now have to suspend the acquisition task it should remain suspend, until either the 
					if the call was sucssefuly resolved or if the voice input of the microphone isn't one of the key words 
					 we only suspend the acquisition task because the processing tasks will be automaticly suspended by the queue*/
					vTaskSuspend(xTskGyroAcquisition);
					i=0;
					}
			}
		 }
	}
}

